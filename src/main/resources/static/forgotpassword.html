<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Handy Craft</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">

    <style>
        .forgot-password-steps {
            display: none;
        }
        .forgot-password-steps.active {
            display: block;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        .step.active .step-number {
            background-color: var(--color-primary);
            color: white;
        }
        .info-box {
            background-color: #f8f9fa;
            border-left: 4px solid var(--color-primary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="auth-page">
<div class="page-wrapper">
    <header class="main-header">
        <nav class="container">
            <div class="logo">
                <a href="index.html" class="logo-link-with-text">
                    <img src="/images/logo.png" alt="Handy Craft Logo" height="40">
                    <span class="site-title">Handy Craft</span>
                </a>
            </div>
            <ul class="nav-links">
                <li>
                    <a href="signin.html" class="back-button">
                        <span>&larr;</span> Back to Sign In
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container" style="flex-grow: 1; display: flex; justify-content: center; align-items: center;">
        <div class="auth-container">
            <h1>Forgot Password</h1>

            <!-- Step 1: Enter Email -->
            <div id="step1" class="forgot-password-steps active">
                <div class="info-box">
                    <p><strong>How it works:</strong> Enter your email below. You'll be asked the security questions you set up during registration. Answer them correctly to reset your password.</p>
                </div>

                <form id="step1-form" class="auth-form">
                    <div class="form-group">
                        <label for="recovery-email">Enter your email address</label>
                        <input type="email" id="recovery-email" name="email" required>
                    </div>
                    <button type="submit" class="button primary full-width">Continue</button>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    Remember your password? <a href="signin.html">Sign In here</a>
                </p>
            </div>

            <!-- Step 2: Answer Questions and Set New Password -->
            <div id="step2" class="forgot-password-steps">
                <div class="info-box">
                    <p><strong>Security Note:</strong> Answers must match exactly (including uppercase/lowercase) as you entered during registration.</p>
                </div>

                <form id="step2-form" class="auth-form">
                    <h3>Answer Security Questions</h3>

                    <div class="form-group">
                        <label>What is your favourite colour?</label>
                        <input type="text" id="answer1" name="answer1" required>
                        <small style="color: #666; font-size: 0.8em;">Answer must match what you entered during registration</small>
                    </div>

                    <div class="form-group">
                        <label>What is your best friend's nickname?</label>
                        <input type="text" id="answer2" name="answer2" required>
                        <small style="color: #666; font-size: 0.8em;">Answer must match what you entered during registration</small>
                    </div>

                    <div class="form-group">
                        <label>What city were you born in?</label>
                        <input type="text" id="answer3" name="answer3" required>
                        <small style="color: #666; font-size: 0.8em;">Answer must match what you entered during registration</small>
                    </div>

                    <hr style="margin: 25px 0;">
                    <h3>Set New Password</h3>

                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" name="newPassword" required>
                        <small style="color: #666; font-size: 0.8em;">
                            - 8-15 characters<br>
                            - At least 1 number, 1 uppercase, 1 lowercase<br>
                            - No spaces allowed
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" name="confirmNewPassword" required>
                    </div>

                    <div class="button-group" style="display: flex; gap: 10px;">
                        <button type="button" class="button secondary" onclick="goToStep(1)" style="flex: 1;">Back</button>
                        <button type="submit" class="button primary" style="flex: 2;">Reset Password</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-links container">
            <p>&copy; 2025 Handy Craft. All rights reserved.</p>
        </div>
    </footer>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8000/api';
    let userEmail = '';

    function goToStep(step) {
        // Hide all steps
        document.querySelectorAll('.forgot-password-steps').forEach(el => {
            el.classList.remove('active');
        });

        // Show target step
        document.getElementById(`step${step}`).classList.add('active');
    }

    // Step 1
    document.getElementById('step1-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        userEmail = document.getElementById('recovery-email').value.trim();

        if (!userEmail) {
            alert('Please enter your email address');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/password-reset/questions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('answer1').value = '';
                document.getElementById('answer2').value = '';
                document.getElementById('answer3').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';

                goToStep(2);
            } else {
                alert(data.message || 'User not found or security questions not set up');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error. Please try again.');
        }
    });

    // Step 2: Verify answers and reset password
    document.getElementById('step2-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const answer1 = document.getElementById('answer1').value;
        const answer2 = document.getElementById('answer2').value;
        const answer3 = document.getElementById('answer3').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;

        // Validate inputs
        if (!answer1 || !answer2 || !answer3 || !newPassword || !confirmPassword) {
            alert('Please fill in all fields');
            return;
        }

        // Validate password
        if (newPassword !== confirmPassword) {
            alert('Passwords do not match');
            return;
        }

        // Length: 8-15 characters
        if (newPassword.length < 8 || newPassword.length > 15) {
            alert("Password must be 8-15 characters.");
            return;
        }

        // Must have at least 1 number
        if (!/\d/.test(newPassword)) {
            alert("Password must contain at least 1 number.");
            return;
        }

        // Must have at least 1 uppercase letter
        if (!/[A-Z]/.test(newPassword)) {
            alert("Password must contain at least 1 uppercase letter.");
            return;
        }

        // Must have at least 1 lowercase letter
        if (!/[a-z]/.test(newPassword)) {
            alert("Password must contain at least 1 lowercase letter.");
            return;
        }

        // No spaces allowed
        if (newPassword.includes(' ')) {
            alert("Password cannot contain spaces.");
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/password-reset/reset`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userEmail,
                    answer1: answer1,
                    answer2: answer2,
                    answer3: answer3,
                    newPassword: newPassword,
                    confirmPassword: confirmPassword
                })
            });

            const data = await response.json();

            if (response.ok) {
                alert('Password reset successfully! You can now sign in with your new password.');
                window.location.href = 'signin.html';
            } else {
                alert(data.message || 'Failed to reset password. Please check your answers.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Password reset failed. Please try again.');
        }
    });
</script>
</body>
</html>